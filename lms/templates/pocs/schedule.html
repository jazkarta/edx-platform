<%! from django.utils.translation import ugettext as _ %>

<script id="poc-schedule-template" type="text/x-handlerbars-template">
  <table class="poc-schedule">
    <thead>
      <tr>
        <th>${_('Unit')}</th>
        <th>${_('Start Date')}</th>
        <th>${_('Due Date')}</th>
        <th><a href="#" id="remove-all">
          <i class="icon-remove-sign icon"></i> ${_('remove all')}
        </a></th>
      </tr>
    </thead>
    <tbody>
      {{#each chapters}}
        <tr class="chapter collapsed" data-location="{{location}}" data-depth="1">
          <td class="unit">
            <a href="#"><i class="icon-caret-right icon toggle-collapse"></i></a> 
            {{display_name}}
          </td>
          <td class="date">{{start}}</td>
          <td class="date">{{due}}</td>
          <td><a href="#"><i class="icon-remove-sign icon"></i> ${_('remove')}</a></td>
        </tr>
        {{#each children}}
          <tr class="sequential collapsed" data-location="{{location}}" data-depth="2">
            <td class="unit">
              <a href="#"><i class="icon-caret-right icon toggle-collapse"></i></a> 
              {{display_name}}
            </td>
            <td class="date">{{start}}</td>
            <td class="date">{{due}}</td>
            <td><a href="#"><i class="icon-remove-sign icon"></i> ${_('remove')}</a></td>
          </tr>
          {{#each children}}
            <tr class="vertical" data-location="{{location}}" data-depth="3">
              <td class="unit">&nbsp;{{display_name}}</td>
              <td class="date">{{start}}</td>
              <td class="date">{{due}}</td>
              <td><a href="#"><i class="icon-remove-sign icon"></i> ${_('remove')}</a></td>
          {{/each}}
        {{/each}}
      {{/each}}
    </tbody>
  </table>
</script>

<div class="poc-schedule-container">
  <div id="poc-schedule"></div>
</div>

<div class="poc-schedule-sidebar">
  <div class="poc-sidebar-panel" id="dirty-schedule">
    <h2>${_('Save changes')}</h2>
    <form role="form">
      <p>${_("You have unsaved changes.")}</p>
      <div class="field">
        <br/>
        <button id="save-changes">${_("Save changes")}</button>
      </div>
    </form>
  </div>
  <div class="poc-sidebar-panel" id="ajax-error">
    <h2>${_('Error')}</h2>
    <p>${_("There was an error saving changes.")}</p>
  </div>
  <div class="poc-sidebar-panel">
    <h2>${_('Schedule a Unit')}</h2>
    <form role="form" id="add-unit" name="add-unit" class="poc-form">
      <div class="field">
        <b>${_('Chapter')}</b><br/>
        <select name="chapter"></select>
      </div>
      <div class="field">
        <b>${_('Sequential')}</b><br/>
        <select name="sequential"></select>
      </div>
      <div class="field">
        <b>${_('Vertical')}</b><br/>
        <select name="vertical"></select>
      </div>
      <div class="field">
        <b>${_('Start Date')}</b><br/>
        <input type="date" name="start_date"/>
        <input type="time" name="start_time"/>
      </div>
      <div class="field">
        <b>${_('Due Date')}</b> ${_('(Optional)')}<br/>
        <input type="date" name="due_date"/>
        <input type="time" name="due_time"/>
      </div>
      <div class="field">
        <br/>
        <button id="add-unit-button">${_('Add Unit')}</button>
      </div>
      <div class="field">
        <br/>
        <button id="add-all">${_('Add All Units')}</button>
      </div>
    </form>
    <div id="all-units-added">
      ${_("All units have been added.")}
    </div>
  </div>
</div>

<script>
var poc_schedule = (function () {
  var save_url = '${save_url}';
  var schedule = ${schedule};
  var template = Handlebars.compile($('#poc-schedule-template').html());
  var chapter_select = $('form#add-unit select[name="chapter"]'),
      sequential_select = $('form#add-unit select[name="sequential"]'),
      vertical_select = $('form#add-unit select[name="vertical"]');

  var self = {
    schedule: schedule,
    dirty: false
  };

  /**
   * Render the course tree view.
   */
  self.render = function() {
    this.hidden = pruned(this.schedule, function(node) {
      return node.hidden || node.category !== 'vertical'});
    this.showing = pruned(this.schedule, function(node) {
      return !node.hidden});

    // Render template
    $('#poc-schedule').html(template({chapters: this.showing}));

    // Start collapsed
    $('table.poc-schedule .sequential,.vertical').hide();

    // Click handlers for collapsible tree
    $('table.poc-schedule .toggle-collapse').on('click', toggle_collapse);

    // Click handler for remove all
    $('table.poc-schedule a#remove-all').on('click', function(event) {
      event.preventDefault();
      schedule_apply(self.schedule, function(node) { node.hidden = true; });
      self.dirty = true;
      self.render();
    });

    // Show or hide form
    if (this.hidden.length) {
      // Populate chapters select, depopulate others
      chapter_select.html('')
        .append('<option value="none">${_("Select a chapter")}...</option>')
        .append(schedule_options(this.hidden));
      sequential_select.html('').prop('disabled', true);
      vertical_select.html('').prop('disabled', true);
      $('form#add-unit').show();
      $('#all-units-added').hide();
      $('#add-unit-button').prop('disabled', true);
    }
    else {
      $('form#add-unit').hide();
      $('#all-units-added').show();
    }

    // Add unit handlers
    chapter_select.on('change', function(event) {
      var chapter_location = chapter_select.val();
      vertical_select.html('').prop('disabled', true);
      if (chapter_location !== 'none') {
        chapter = find_unit(self.hidden, chapter_location);
        sequential_select.html('')
          .append('<option value="all">${_("All sequentials")}</option>')
          .append(schedule_options(chapter.children));
        sequential_select.prop('disabled', false);
        $('#add-unit-button').prop('disabled', false);
      }
      else {
        sequential_select.html('').prop('disabled', true);
      }
    });

    sequential_select.on('change', function(event) {
      var sequential_location = sequential_select.val();
      if (sequential_location !== 'all') {
        var chapter = chapter_select.val();
        sequential = find_unit(self.hidden, chapter, sequential_location);
        vertical_select.html('')
          .append('<option value="all">${_("All verticals")}</option>')
          .append(schedule_options(sequential.children));
        vertical_select.prop('disabled', false);
      }
      else {
        vertical_select.html('').prop('disabled', true);
      } 
    });

    $('#add-unit-button').on('click', function(event) {
      event.preventDefault();
      var chapter = chapter_select.val(),
          sequential = sequential_select.val(),
          vertical = vertical_select.val(),
          units = find_lineage(self.schedule,
            chapter,
            sequential == 'all' ? null : sequential,
            vertical == 'all' ? null: vertical)
      units.map(function(x) { x.hidden = false; });
      unit = units[units.length - 1]
      schedule_apply([unit], function(x) { x.hidden = false; });      
      self.dirty = true;
      self.render();
    });

    // Show or hide save button
    if (this.dirty) $('#dirty-schedule').show()
    else $('#dirty-schedule').hide();

    // Handle save button
    $('#dirty-schedule #save-changes').on('click', function(event) {
        event.preventDefault();
        self.save();
    });

    $('#ajax-error').hide();
  }

  /**
   * Returns a sequence of <option> DOM elements for a particular sequence
   * of schedule nodes.
   */
  function schedule_options(nodes) {
    return nodes.map(function(node) {
      return $('<option>')
        .attr('value', node.location)
        .text(node.display_name)[0];
    });
  }

  /**
   * Return a schedule pruned by the given filter function.
   */
  function pruned(tree, filter) {
    return tree.filter(filter)
      .map(function(node) {
        var copy = {};
        $.extend(copy, node);
        if (node.children) copy.children = pruned(node.children, filter);
        return copy;
      })
      .filter(function(node) {
        return node.children === undefined || node.children.length;
      });
  }

  /**
   * Get table rows that represent the children of given row in the schedule
   * tree.
   */
  function get_children(row) {
    var depth = $(row).data('depth');
    return $(row).nextUntil(
      $(row).siblings().filter(function() {
        return $(this).data('depth') <= depth;
      })
    );
  }

  /**
   * Handle click event for expanding/collapsing nodes in the schedule tree.
   */
  function toggle_collapse(event) {
    event.preventDefault();
    var row = $(this).closest('tr');
    var children = get_children(row);

    if (row.is('.expanded')) {
      $(this).removeClass('icon-caret-down').addClass('icon-caret-right');
      row.removeClass('expanded').addClass('collapsed');
      children.hide(); 
    }

    else {
      $(this).removeClass('icon-caret-right').addClass('icon-caret-down');
      row.removeClass('collapsed').addClass('expanded');
      children.filter('.collapsed').each(function() {
        children = children.not(get_children(this));
      });
      children.show(); 
    }
  }

  /**
   * Save changes.
   */
  self.save = function() {
    var button = $('#dirty-schedule #save-changes'),
        button_text = button.text();
    button.prop('disabled', true).text('${_("Saving")}...');
    
    $.ajax({
        url: save_url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(this.schedule),
        success: function(data, textStatus, jqXHR) {
          self.schedule = data;
          self.dirty = false;
          self.render();
          button.prop('disabled', false).text(button_text);
        },
        error: function(jqXHR, textStatus, error) {
          console.log(jqXHR.responseText);
          $('#ajax-error').show();
          $('#dirty-schedule').hide();
          $('form#add-unit select,input,button').prop('disabled', true);
        }
      });
  }

  /**
   * Add all nodes.
   */
  $('#add-all').on('click', function(event) {
      event.preventDefault();
      schedule_apply(self.schedule, function(node) {
        node.hidden = false;
      });
      self.dirty = true;
      self.render();
  });

  /**
   * Visit every tree node, applying function.
   */
  function schedule_apply(nodes, f) {
    nodes.map(function(node) {
      f(node);
      if (node.children !== undefined) schedule_apply(node.children, f);
    });
  }

  /**
   * Find a unit in the tree.
   */
  function find_unit(tree, chapter, sequential, vertical) {
    var units = find_lineage(tree, chapter, sequential, vertical);
    return units[units.length -1];
  }

  function find_lineage(tree, chapter, sequential, vertical) {
    function find_in(seq, location) {
      for (var i = 0; i < seq.length; i++)
        if (seq[i].location === location)
          return seq[i];
    }

    var units = [],
        unit = find_in(tree, chapter);
    units[units.length] = unit;
    if (sequential) {
      units[units.length] = unit = find_in(unit.children, sequential);
      if (vertical) 
        units[units.length] = unit = find_in(unit.children, vertical);
    }

    return units;
  }

  return self;
})();

$(function() { poc_schedule.render(); });
</script>
